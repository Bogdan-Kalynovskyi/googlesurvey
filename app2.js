"use strict";function Chart(t){var e,r,n,a=this;this.create=function(r,s){google.charts.setOnLoadCallback(function(){function i(t){for(var e="",r=0;r<t.length;r++){var n=t[r].toString().replace(/"/g,'""');n.search(/("|,|\n)/g)>=0&&(n='"'+n+'"'),e+=r>0?","+n:n}return e+"\n"}for(var o="",d=0,l=r.length,u=new Array(l+1);d<l;d++){var c=r[d],h=c[1]/total*100,g=[c[0],h],f=[c[0],h,c[1]];u[d+1]=g,o+=i(f)}a.csvStr=o,a.csvBlob=new Blob([o],{type:"text/csv;charset=utf-8;"}),u[0]=["","Tag %"],e=google.visualization.arrayToDataTable(u),t.style.height=28*l+"px",n||(n=new google.charts.Bar(t)),n.draw(e,{bars:"horizontal"}),$("#comment-chart").html("<small>Question: "+s.question+"<br>Total answers: "+s.total+"</small><br><br>")})},this.update=function(){clearTimeout(r),r=setTimeout(function(){n&&n.draw(e,{bars:"horizontal"})},100)}}function SimpleTable(t){this.create=function(e){for(var r="",n=0,a=e.length;n<a;n++){var s=e[n];r+="<tr><td>"+s[0]+"</td><td>"+(100*s[1]/total).toFixed(2)+"%</td><td>"+s[1]+"</td></tr>"}t.innerHTML='<table class="table table-striped table-bordered table-hover"><thead class="thead-default"><tr><th>Tag</th><th>%</th><th>Answers</th></tr></thead><tbody>'+r+"</tbody></table>"}}function Table(t){function e(t){return(100*t/total).toFixed(2)}function r(t){for(var r="",n=0,a=t.length;n<a;n++){var s,i,o=t[n];if(v&&(s=o[2])){l||(s=s.split(","),o[2]=s,o[3]=o[3].split(",")),i="<ul>";for(var d=0,u=s.length;d<u;d++)i+="<li><span draggable=true>"+s[d]+"</span><del-syn>×</del-syn></li>";i+="</ul>"}else i="";r+="<tr"+(v?' ondragover="return false"':"")+"><td><input type=checkbox></td><td><span draggable=true>"+o[0]+"</span>"+i+"</td><td>"+e(o[1])+"%</td><td>"+o[1]+"</td><td class=del-line>×</td></tr>"}return r}function n(){c=t.querySelector("thead input"),c.onchange=function(){for(var t=l.children,e=this.checked,r=0,n=t.length;r<n;r++)(v||h[r])&&(t[r].children[0].children[0].checked=e)}}function a(t){for(;t&&"TR"!==t.tagName;)t=t.parentNode;return t}function s(t){for(;t&&t.getAttribute&&!t.getAttribute("ondragover");)t=t.parentNode;return t}function i(t){var e=a(t),r=Array.prototype.slice.call(l.children);return r.indexOf(e)}function o(){var e,r,n=t.children[0];l.addEventListener("dragstart",function(t){window.getSelection?window.getSelection().removeAllRanges():document.selection&&document.selection.empty();var e=t.target;if(!(e instanceof HTMLElement&&e.draggable))return!1;var r=a(e),n="LI"===e.parentNode.tagName;dragData={index:i(r),startRow:r,html:n?e.children[0].innerHTML:0,isSynonym:n,isTagsTable:v},u.find("input:checked").css("outline","5px solid rgba(0, 0, 255, 0.22)")}),n.addEventListener("dragenter",function(t){var a=t.target;r&&r.contains(a)||(r&&(e.style.background="",e.style.outline="",r=void 0),dragData.startRow.contains(a)||(a=v?s(a):n,a!==document&&(r=a,e="THEAD"===a.tagName?a.parentNode:a,e.style.background="rgba(0, 0, 255, 0.1)",e.style.outline="2px solid blue"))),c.checked=!1,t.stopPropagation()}),document.addEventListener("dragenter",function(){r&&(e.style.background="",e.style.outline="",r=void 0)}),n.addEventListener("drop",function(t){var n=s(t.target),a=v&&"TR"===n.tagName,o={index:a&&i(n),isRow:a,isTagsTable:v};r&&(e.style.background="",e.style.outline=""),ctrl.dragTag(dragData,o)})}function d(){l.addEventListener("click",function(t){var e=t.target,r=e.tagName;if("SPAN"===r){var n=e.innerHTML;e.style.padding="0",e.innerHTML='<input value="'+n+'">';var a=e.children[0];a.focus(),a.onblur=function(){var t=a.value;t&&n!==a.value&&ctrl.updateTag(v,i(e),"LI"===e.parentNode.tagName,t,n),e.style.padding="",e.innerHTML=t},a.onkeyup=function(t){13!=t.keyCode&&27!=t.keyCode||this.blur()}}else"DEL-SYN"===r?ctrl.deleteSyn(i(e),e.parentNode.children[0].innerHTML):"del-line"===e.className&&ctrl.deleteRow(i(e),v)})}var l,u,c,h,g,f=document.getElementById("logged-in"),v="tags-table"===t.id;this.create=function(e,a){return v||(h=Array(total).fill(!0)),$undo.innerHTML="",l&&!a?void this.update(e):(l=null,t.innerHTML='<table class="table table-striped table-bordered table-hover"'+(v?"":' ondragover="return false"')+'><thead class="thead-default"'+(v?' ondragover="return false"':"")+"><tr><th colspan=5><b>"+(v?"Tags and synonyms":"Unused terms")+"</b></th></tr><tr><th><input type=checkbox></th><th>"+(v?"Tag":"Term")+"</th><th colspan=3>Answers</th></tr><tr><th colspan=5>"+(v?"Drop on header to create a tag, drop on tag to create synonym":"Drag here to exclude. You can drag multiple by selecting the checkboxes")+"</th></tr></thead><tbody>"+r(e)+"</tbody></table>",l=t.children[0].children[1],void setTimeout(function(){u=$(l),ctrl=ctrl||angular.element(f).scope().ctrl,n(),o(),d()},0))},this.selectedIndexes=function(){for(var t=[],e=l.children,r=0,n=e.length;r<n;r++)(v||h[r])&&e[r].children[0].children[0].checked&&t.push(r);return t},this.filter=function(t,e){var r,n,a=l.children;if(e.length){for(var s=0,i=t.length;s<i;s++)n=t[s][0].indexOf(e)!==-1,r=a[s],n!=h[s]&&(r.style.display=n?"table-row":"none"),h[s]=n,g||(r.children[0].children[0].checked=!1);c.checked=!1,g=!0}else{for(s=0,i=t.length;s<i;s++)h[s]||(a[s].style.display="table-row");h=Array(total).fill(!0),g=!1}},this.updatePerc=function(t){for(var r=l.children,n=0,a=r.length;n<a;n++)r[n].children[2].innerHTML=e(t[n][1])+"%"},this.update=function(t){l.innerHTML="",this.addRows(t)},this.addRow=function(t){u.prepend(r([t])),v||h.unshift(!0)},this.addRows=function(t){u.prepend(r(t)),v||(h=Array(t.length).fill(!0).concat(h))},this.addSubTerm=function(t,r,n){var a=l.children[t],s=a.children[1].children[1],i="<li><span draggable=true>"+r+"</span><del-syn>×</del-syn></li>";s?$(s).append(i):$(a.children[1].children[0]).after("<ul>"+i+"</ul>"),a.children[2].innerHTML=e(n)+"%",a.children[3].innerHTML=n},this.addSubTerms=function(t,e){var r=$(l.children[t].children[1].children[1]),n=e.join("</span><del-syn>×</del-syn></li><li><span draggable=true>");r.append("<li><span draggable=true>"+n+"</span><del-syn>×</del-syn></li>")},this.deleteSyn=function(t,r,n){var a=l.children[t],s=a.children[1].children[1];s.removeChild(s.children[r]),a.children[2].innerHTML=e(n)+"%",a.children[3].innerHTML=n},this.deleteRow=function(t,e,r){l.removeChild(l.children[t]),void 0!==r&&($undo.prepend("<div><undo trash-id="+r+">undo</undo> "+e+"<del-undo>×</del-undo></div>"),v||h.splice(t,1))}}function alreadyLoggedIn(){$("#logged-out").hide();var t=$("#logged-in").show();angular.bootstrap(t[0],["app"])}var app=angular.module("app",[]).config(["$httpProvider",function(t){function e(t){!document.hidden&&r&&(bootstrapAlert(t),r=!1,setTimeout(function(){r=!0},2e4))}var r=!0,n=navigator.userAgent,a=n.indexOf("MSIE ");a!==-1?a=parseInt(n.split("MSIE ")[1]):n.match(/trident.*rv\:11\./)&&(a=11),a!==-1&&(document.documentElement.className="ie"+a,a<10&&bootstrapAlert("You are using Internet Explorer "+a+". Sorry, but we are only supporting Internet Explorer 10 and above. Chrome, Firefox and Safari are also supported.")),window.onbeforeunload=function(){r=!1},t.defaults.headers.common.Authorization=xsrfToken,t.interceptors.push(["$q","$injector",function(t,n){function a(a,i){if(s<16){s++;var o=n.get("$timeout");return o(function(){var t=n.get("$http");return t(a)},600*s)}if(r){e(i===-1?"Oops, it seems you have lost internet connection":"We are restarting server. Could you please try in a minute?"),s=0;var d=t.defer();return d.reject(),d.promise}}var s=0;return{response:function(e){return e||t.when(e)},responseError:function(e){switch(e.status){case 400:case 401:bootstrapAlert(e.data),401===e.status&&$(".modal button").click(function(){location.reload()});break;case-1:if(e.status===-1&&e.config.timeout)break;return a(e.config,e.status)}return t.reject(e)}}}])}]);app.directive("customOnChange",function(){return{restrict:"A",link:function(t,e,r){var n=t.$eval(r.customOnChange);e.bind("change",n)}}}),google.charts.load("44",{packages:["bar"]}),app.controller("dashboard",["model","surveys","$rootScope","$q",function(t,e,r,n){function a(t){return document.getElementById(t)}function s(t){u.filterTerm="",l=[],u.navigate("tags"),u.splitMax(!0),a("tags-question").innerHTML=t}function i(e,r){var n;if(e.isTagsTable)if(r.isTagsTable){if(e.index===r.index)return!1;if(r.isRow)e.isSynonym?(n=t.deleteSyn(e.index,e.html),t.addSubTerm(r.index,n[0],n[1])):(t.addSubTerms(e.index,r.index),t.deleteTag(e.index));else{if(!e.isSynonym)return!1;n=t.deleteSyn(e.index,e.html),t.addTag(n)}}else e.isSynonym?n=t.deleteSyn(e.index,e.html):(n=t.tagsArr[e.index],n[2]&&t.addTerms(n),t.deleteTag(e.index)),t.addTerm(n);else{if(!r.isTagsTable)return!1;n=t.termsArr[e.index],t.deleteTerm(e.index),r.isRow?t.addSubTerm(r.index,n[0],n[1]):t.addTag(n)}o()}function o(){clearTimeout(g),g=setTimeout(function(){u.sId&&!c?(u.surveys[u.sId].total=total,t.overwriteSurvey(u.sId)):(c=!1,t.saveNewSurvey().then(function(r){u.sId=r,e.add(t.surveyId,t.surveyData)}))},600)}var d,l,u=this,c=!1,h=new Chart(a("tags-chart"));t.tagsTable=new Table(a("tags-table")),t.termsTable=new Table(a("terms-table")),this.maxTags=10,e.load().success(function(){$("#loading").remove(),u.navigate("surveys"),u.surveys=e.surveys}),window.addEventListener("resize",function(){"chart"===d&&h.update()},100),this.navigate=function(r){if("surveys"!==r&&!t.tagsArr&&!this.sId)return void alert("Nothing to display, survey not loaded yet");if(d&&(a("btn-"+d).classList.remove("active"),a(d).style.display="none"),a("btn-"+r).classList.add("active"),a(r).style.display="block",d=r,"chart"===r){h.create(t.tagsArr,e.surveys[this.sId]);var n=new SimpleTable(a("chart-table"));n.create(t.tagsArr)}},this.splitMax=function(e){this.maxTags&&(this.minRepeat=t.splitMax(this.maxTags,e),o())},this.splitMin=function(){this.maxTags=t.splitMin(this.minRepeat),o()},this.loadSurvey=function(r){this.sId=r,this.filterTerm="",l=[],this.navigate("tags"),a("tags-question").innerHTML=e.surveys[this.sId].question,total=+e.surveys[r].total,t.getTagsBySurveyId(r).success(function(){t.tagsTable.create(t.tagsArr,!0),u.maxTags=t.tagsArr.length,u.minRepeat=t.tagsArr[u.maxTags-1][1]}),t.getTermsBySurveyId(r).success(function(){t.termsTable.create(t.termsArr,!0)})},this.duplicateSurvey=function(r){this.loadSurvey(r),t.surveyData=e.surveys[r],c=!0},this.uploadFile=function(r){var n=r.target.files[0];if(n&&!n.$error){var a=new FileReader;a.onload=function(r){var n=XLS.read(r.target.result,{type:"binary"}),a=n.Sheets.Overview,i=e.findByGoogleId(a.A2.w),o="Survey with this id has already been uploaded. Do you want to overwrite existing one or add as a new survey?";i!==-1?bootstrapConfirm(o,"Add as new","Overwrite",function(e){2===e?u.sId=i:u.sId=void 0,s(t.initByExcel(n))}):(u.sId=void 0,s(t.initByExcel(n)))},a.readAsBinaryString(n)}},this.addTags=function(){var e=[];this.bulkAdd.toLowerCase().split(",").forEach(function(t){var r=t.trim();r.length&&e.push([r,0])}),this.bulkAdd="",t.addTags(e),t.tagsTable.update(t.tagsArr),o()},this.updateTag=function(){t.updateTag.apply(t,arguments),o()},this.deleteRow=function(e,r){if(r){total-=t.tagsArr[e][1];var n=l.push([t.tagsArr[e],r])-1;t.deleteTag(e,n)}else{total-=t.termsArr[e][1];var n=l.push([t.termsArr[e],r])-1;t.deleteTerm(e,n)}t.tagsTable.updatePerc(t.tagsArr),t.termsTable.updatePerc(t.termsArr),o()},this.deleteSyn=function(e,r){var n=t.deleteSyn(e,r);total-=n[1],t.tagsTable.updatePerc(t.tagsArr),t.termsTable.updatePerc(t.termsArr),o()},this.undoRow=function(e){var r=l[e];r[1]?t.addTag(r[0]):t.addTerm(r[0]),total+=r[0][1],t.tagsTable.updatePerc(t.tagsArr),t.termsTable.updatePerc(t.termsArr),o()},this.dragTag=function(e,r){var n=e.isTagsTable?t.tagsTable:t.termsTable,a=n.selectedIndexes(),s=a.length;if(s)for(var o={isTagsTable:e.isTagsTable,isSynonym:!1};s--;)o.index=a[s],i(o,r);else i(e,r)},this.sort=function(){t.sort(t.termsArr),setTimeout(function(){t.termsTable.update(t.termsArr)},0)},this.filterTerms=function(){t.filterTerms(this.filterTerm)};var g;this.downloadCsv=function(){var t="tags_"+e.surveys[this.sId].survey_google_id+".csv";if(navigator.msSaveBlob)navigator.msSaveBlob(h.csvBlob,t);else{var r=document.createElement("a");if(void 0!==r.download){var n=URL.createObjectURL(h.csvBlob);r.setAttribute("href",n),r.setAttribute("download",t),r.style.visibility="hidden",document.body.appendChild(r),r.click(),setTimeout(function(){document.body.removeChild(r)},1e4)}else{var a=window.open("","","");a.document.write('<meta name=content-type content=text/csv><meta name=content-disposition content="attachment;  filename='+t+'">  '),a.document.write(h.csvStr)}}},this.deleteSurveyById=function(t){confirm("Do you really want to delete this survey and all its data?")&&(e["delete"](t),t===this.sId&&($("tr[ondragover]").remove(),$("#tags-chart").html("")))},this.logOut=function(){n.all([t.logOut(),gapi.auth2.getAuthInstance().signOut()]).then(function(){location.reload()})}}]);var total;app.service("model",["$http",function(t){function e(){for(var t=0,e=a.tagsArr,r=e.length,n=new Array(r);t<r;t++){var s=e[t];n[t]=s.slice(0,2),s[2]&&(n[t].push(s[2].join(",")),n[t].push(s[3].join(",")))}return n}function r(t){var e=[];for(var r in t)e.push([r,t[r]]);return a.sort(e)}function n(){for(var t=a.termsArr,e=0,r=t.length;e<r;e++)if(t[e][2]){for(var n=t[e],s=n[2],i=n[3],o=0,d=s.length;o<d;o++)a.termsArr.push([s[o],i[o]]);n.splice(2,2)}}var a=this;this.initByExcel=function(t){try{for(var e,n=t.Sheets["Complete responses"],a=t.Sheets.Overview,s={},i=2;e=n["K"+i];){for(var o=e.w.trim().toLowerCase().split(/ and | or | - | but |\.|,|;|:|\?|!|&+/),d=0,l=o.length;d<l;d++){var u=o[d].trim();u.length&&(s[u]?s[u]++:s[u]=1)}i++}this.tagsArr=r(s),this.termsArr=[];var c=a.C2.w,h=+a.E2.w;this.surveyData={survey_google_id:a.A2.w,question:c,total:h},total=h}catch(g){bootstrapAlert("Could not parse answers from Excel file")}return c},this.getTagsBySurveyId=function(e){return t.get("api/tags.php?surveyId="+e).success(function(t){a.tagsArr=t})},this.getTermsBySurveyId=function(e){return t.get("api/terms.php?surveyId="+e).success(function(t){a.termsArr=t})},this.saveNewSurvey=function(){return t.post("api/surveys.php",{survey_google_id:this.surveyData.survey_google_id,question:this.surveyData.question,tagsArr:e(this.tagsArr),termsArr:this.termsArr,total:total}).then(function(t){return a.surveyId=t.data})},this.overwriteSurvey=function(r){return t.put("api/surveys.php",{surveyId:r,tagsArr:e(a.tagsArr),termsArr:this.termsArr,total:total})},this.addTag=function(t){this.tagsArr.unshift(t),this.tagsTable.addRow(t)},this.addTags=function(t){total+=t.length,this.tagsArr=t.concat(this.tagsArr),this.tagsTable.addRows(t)},this.addSubTerm=function(t,e,r){var n=this.tagsArr[t];n[2]?(n[2].push(e),n[3].push(r)):(n.push([e]),n.push([r])),n[1]+=+r,this.tagsTable.addSubTerm(t,e,n[1])},this.addSubTerms=function(t,e){var r=this.tagsArr[t],n=this.tagsArr[e],a=r[2];this.addSubTerm(e,r[0],r[1]),a&&(n[2]=n[2].concat(a),n[3]=n[3].concat(r[3]),this.tagsTable.addSubTerms(e,a))},this.addTerm=function(t){this.termsArr.unshift(t),this.termsTable.addRow(t)},this.addTerms=function(t){for(var e=[],r=0,n=t[2],a=t[3],s=0,i=n.length;s<i;s++)r+=+a[s],e.push([n[s],a[s]]);t[1]-=r,this.termsArr=e.concat(this.termsArr),this.termsTable.addRows(e)},this.deleteTag=function(t,e){this.tagsTable.deleteRow(t,this.tagsArr[t][0],e),this.tagsArr.splice(t,1)},this.deleteSyn=function(t,e,r){var n=this.tagsArr[t],a=n[2],s=a.indexOf(e),i=[e,n[3][s]];return a.splice(s,1),n[1]-=n[3][s],n[3].splice(s,1),this.tagsTable.deleteSyn(t,s,n[1],r),i},this.deleteTerm=function(t,e){this.termsTable.deleteRow(t,this.termsArr[t][0],e),this.termsArr.splice(t,1)},this.updateTag=function(t,e,r,n,a){if(t)if(r){var s=this.tagsArr[e][2];s[s.indexOf(a)]=n}else this.tagsArr[e][0]=n;else this.termsArr[e][0]=n},this.sort=function(t){function e(t,e){return t[0]>e[0]?1:t[0]<e[0]?-1:0}return t.sort(e)},this.splitMax=function(t,e){var r=this.tagsArr.concat(this.termsArr);return t=Math.min(t,r.length),this.sort(r),this.tagsArr=r.slice(0,t),this.termsArr=r.slice(t),n(),this.tagsTable.create(this.tagsArr,e),this.termsTable.create(this.termsArr,e),this.tagsArr[t-1][1]},this.splitMin=function(t){var e=this.tagsArr.concat(this.termsArr),r=0,a=e.length;for(this.sort(e);r<a&&e[r][1]>=t;)r++;return this.tagsArr=e.slice(0,r),this.termsArr=e.slice(r),n(),this.tagsTable.create(this.tagsArr),this.termsTable.create(this.termsArr),r},this.filterTerms=function(t){this.termsTable.filter(this.termsArr,t)},this.logOut=function(){return t.post("api/login.php",{logout:xsrfToken})}}]),app.service("surveys",["$http",function(t){var e=this,r="api/surveys.php";this.load=function(){return t.get(r).success(function(t){e.surveys=t})},this.add=function(t,e){this.surveys[t]=e},this["delete"]=function(n){return t["delete"](r+"?surveyId="+n).success(function(){delete e.surveys[n]})},this.findByGoogleId=function(t){for(var e in this.surveys)if(this.surveys[e].survey_google_id===t)return e;return-1}}]);var $undo=$("#undo"),ctrl,dragData;$undo[0].onclick=function(t){var e=t.target,r=e.tagName;"UNDO"===r?(ctrl.undoRow(e.getAttribute("trash-id")),$undo[0].removeChild(e.parentNode)):"DEL-UNDO"===r&&$undo[0].removeChild(e.parentNode)},function(){function t(t){t.addClass("in").show(),t.find("button").on("click",function(){t.removeClass("in"),setTimeout(function(){t.remove()},300)})}var e='<div class="modal fade"><div class=modal-dialog><div class=modal-content><div class=modal-body><button class=close data-dismiss=modal>&times;</button><br>',r="</div></div></div></div>";window.bootstrapAlert=function(n){$("#modal-placeholder").append(e+n+'<br><button class="btn btn-sm btn-primary center-block m-t-1 p-x-3" data-dismiss=modal>Ok</button>'+r);var a=$(".modal");t(a),a.find(".btn-primary").focus()},window.bootstrapConfirm=function(n,a,s,i){$("#modal-placeholder").append(e+n+'<br><button class="btn btn-sm btn-primary pull-xs-right m-l-2 m-y-1" data-dismiss=modal>&nbsp; '+a+' &nbsp;</button><button class="btn btn-sm btn-secondary pull-xs-right m-y-1" data-dismiss=modal>&nbsp; '+s+' &nbsp;</button><br class="clearfix"><br><br>'+r);var o=$(".modal");t(o),o.find(".btn-primary").on("click",function(){i(1)}).focus(),o.find(".btn-secondary").on("click",function(){i(2)})}}(),window.googleUser&&logIn(googleUser),window.xsrfToken&&alreadyLoggedIn();