function Chart(t){function e(a){try{t.style.height=26.05*a.getNumberOfRows()+"px",r||(r=new google.charts.Bar(t)),r.draw(a,{chart:{},bars:"horizontal"})}catch(n){setTimeout(function(){e(a)},1e3)}}var r;this.create=function(t){t.unshift(["","Tag repeat"]),e(google.visualization.arrayToDataTable(t)),t.shift()}}function Table(t){function e(t){for(var e="",r=0,a=t.length;r<a;r++){var n,s=t[r],d="";if(i&&(n=s[2])){o&&(n=n.split(","),s[2]=n),d="<ul>";for(var u=0,l=n.length;u<l;u++)d+="<li draggable=true>"+n[u]+"</li>";d+="</ul>"}e+='<tr ondragover="return false"><td><input type=checkbox></td><td><span draggable=true>'+s[0]+"</span></td><td>"+s[1]+d+"</td></tr>"}return e}function r(){t.querySelector("thead input").onchange=function(){for(var t=s.getElementsByTagName("input"),e=this.checked,r=0,a=t.length;r<a;r++)t[r].checked=e}}function a(){function e(t,e){var r=e?$(t).closest("tr")[0]:t,a=Array.prototype.slice.call(s.children);return a.indexOf(r)}var r,a,n,o=t.children[0];s.addEventListener("dragstart",function(a){var n=a.target,s=a.dataTransfer;return n instanceof HTMLElement&&n.draggable===!0&&(s.setData("index",e(n,!0)),s.setData("target",n.tagName),"LI"===n.tagName&&s.setData("html",n.innerHTML),s.setData("table",t.id),void(r=$(n).closest("[ondragover]")[0]))}),o.addEventListener("dragenter",function(t){var e=t.target;a&&a.contains(e)||(a&&(a.style.background="",n.style.outline="",a=void 0),r&&r.contains(e)||(e=$(e).closest("[ondragover]")[0],e&&(a=e,"THEAD"===e.tagName?n=e.parentNode:i?(n=e,e.style.background="rgba(0, 0, 255, 0.15)"):n=e.parentNode.parentNode,n.style.outline="2px solid blue"))),t.stopPropagation()}),document.addEventListener("dragenter",function(){a&&(a.style.background="",n.style.outline="",a=void 0)}),o.addEventListener("drop",function(r){var s=$(r.target).closest("[ondragover]")[0],i=r.dataTransfer,o={index:+i.getData("index"),target:i.getData("target"),html:i.getData("html"),table:i.getData("table")},d={index:"TR"===s.tagName&&e(s),target:s.tagName,table:t.id};a&&(a.style.background="",n.style.outline=""),$(s).closest("thead").length&&(d.target="THEAD"),angular.element(document.body).scope().ctrl.dragTag(o,d)})}function n(){s.addEventListener("click",function(e){var r=e.target;if("SPAN"===r.tagName||"LI"===r.tagName){var a=r.innerHTML;r.innerHTML='<input value="'+a+'">';var n=r.children[0];n.focus(),n.onblur=function(){if(n.value&&a!==n.value){var e=Array.prototype.slice.call(s.children),i=e.indexOf(r.parentNode.parentNode);angular.element(document.body).scope().ctrl.updateTag(t.id,i,r.tagName,n.value,a)}r.innerHTML=n.value}}})}var s,i="tags-table"===t.id,o=!0;this.create=function(d){return s?void this.update(d):(t.innerHTML='<table class="table table-striped table-bordered table-hover"><thead class="thead-default" ondragover="return false"><tr><th><input type=checkbox></th><th>'+(i?"Tag":"Term")+"</th><th>Repeat</th></tr><tr><th colspan=3>"+(i?"Drop on header to create a tag, drop on tag to create synonym":"Drop here to remove tag or synonym from use")+"</th></tr></thead><tbody>"+e(d)+"</tbody></table>",s=t.getElementsByTagName("tbody")[0],r(),a(),n(),void(o=!1))},this.update=function(t){s.innerHTML="",this.addRows(t)},this.makePinkRows=function(t,e){for(var r=s.children,a=t;a<e;a++)r[a].style.background="repeating-linear-gradient(45deg,transparent,transparent 10px,#eee 10px,#eee 20px),linear-gradient(to bottom,#fff,#ddd)"},this.addRow=function(t){$(s).prepend(e([t]))},this.addRows=function(t){$(s).prepend(e(t))},this.addSubTerm=function(t,e){var r=$(s.children[t]),a=r.find("ul"),n="<li draggable=true>"+e[0]+"</li>";a.length?a.append(n):r.find("span").after("<ul>"+n+"</ul>")},this.deleteSubTerm=function(t,e){s.removeChild(s.children[t].children[0].children[1].children[e])},this.deleteRow=function(t){s.removeChild(s.children[t])},this.selectedIndexes=function(){for(var t=[],e=s.getElementsByTagName("input"),r=0,a=e.length;r<a;r++)e[r].checked&&t.push(r);return t}}!function(){"use strict";angular.module("app",[]).config(function(t){function e(t){!document.hidden&&r&&(bootstrapAlert(t),r=!1,setTimeout(function(){r=!0},2e4))}var r=!0,a=navigator.userAgent,n=a.indexOf("MSIE ");n!==-1?n=parseInt(a.split("MSIE ")[1]):a.match(/trident.*rv\:11\./)&&(n=11),n!==-1&&(document.documentElement.className="ie"+n,n<10&&bootstrapAlert("You are using Internet Explorer "+n+". Sorry, but we are only supporting Internet Explorer 10 and above. Chrome, Firefox and Safari are also supported.")),window.onbeforeunload=function(){r=!1},t.defaults.headers.common.Authorization=xsrfToken,t.interceptors.push(function(t,a){function n(n,i){if(s<16){s++;var o=a.get("$timeout");return o(function(){var t=a.get("$http");return t(n)},600*s)}if(r){e(i===-1?"Oops, it seems you have lost internet connection":"Wow, the server is experiencing overload. Could you please try in a minute?"),s=0;var d=t.defer();return d.reject(),d.promise}}var s=0;return{response:function(e){return e||t.when(e)},responseError:function(e){switch(e.status){case 401:case 403:bootstrapAlert(e.data);break;case-1:if(e.status===-1&&e.config.timeout)break;return n(e.config,e.status)}return t.reject(e)}}})}),angular.module("app").directive("customOnChange",function(){return{restrict:"A",link:function(t,e,r){var a=t.$eval(r.customOnChange);e.bind("change",a)}}})}(),function(){"use strict";google.charts.load("current",{packages:["bar"]}),angular.module("app").controller("dashboard",function(t,e,r){function a(){s.navigate("tags"),s.filterTags()}var n,s=this,i=new Chart(document.getElementById("tags-chart"));e.tagsTable=new Table(document.getElementById("tags-table")),e.termsTable=new Table(document.getElementById("terms-table")),this.maxTags=10,this.minRepeat=3,$(".nav-body").hide(),r.loadSurveys().success(function(){s.navigate("surveys"),s.surveys=r.surveys}),this.navigate=function(t){switch(n&&($("[data-active="+n+"]").removeClass("active"),$("#"+n).hide()),$("[data-active="+t+"]").addClass("active"),$("#"+t).show(),n=t,t){case"chart":e.tagsArr.length?i.create(e.tagsArr):alert("Tags loaded already?")}},this.filterTags=function(){e.splitTags(this.maxTags,this.minRepeat)},this.loadSurveyById=function(t){this.navigate("tags"),this.surveyId=t,e.getTagsBySurveyId(t).success(function(){e.tagsTable.create(e.tagsArr)}),e.getTermsBySurveyId(t).success(function(){e.termsTable.create(e.termsArr)})},this.deleteSurveyById=function(t){confirm("Do you really want to delete this survey and all its data?")&&(r.deleteSurvey(t),t===e.surveyId&&(s.tagsPresent=!1))},this.uploadFile=function(t){var n=t.target.files[0];if(n&&!n.$error){var i=new FileReader;i.onload=function(t){var n=XLS.read(t.target.result,{type:"binary"}),i=n.Sheets.Overview,o=r.findByGoogleId(i.A2.w),d="Survey with this id has already been uploaded. Do you want to overwrite existing one or add as a new survey?";o!==-1?bootstrapConfirm(d,"Add as new","Overwrite",function(t){2===t?s.surveyId=o:s.surveyId=void 0,e.initByExcel(n),a()}):(s.surveyId=void 0,e.initByExcel(n),a())},i.readAsBinaryString(n)}},this.addTags=function(t){var r=[];t.toLowerCase().split(/ and | or |\.|,|;|:|\?|!|&+/).forEach(function(t){var e=t.trim();e.length&&r.push([e,0])}),e.addTags(r),e.tagsTable.update(e.tagsArr)},this.updateTag=function(){e.updateTag.apply(e,arguments)},this.dragTag=function(t,r){var a;if("tags-table"===t.table)if("tags-table"===r.table){if(t.index===r.index)return!1;if("THEAD"!==r.target)"SPAN"===t.target?(a=e.tagsArr[t.index],a[2]&&(e.strToArr(a).forEach(function(t){e.addSubTerm(r.index,t)}),a.splice(2,2)),e.addSubTerm(r.index,a),e.deleteTag(t.index)):(a=e.deleteSubTerm(t.index,t.html),e.addSubTerm(r.index,a));else{if("LI"!==t.target)return!1;a=e.deleteSubTerm(t.index,t.html),e.addTag(a)}}else"SPAN"===t.target?(a=e.tagsArr[t.index],a[2]&&(e.addTerms(e.strToArr(a)),a.splice(2,2)),e.deleteTag(t.index)):a=e.deleteSubTerm(t.index,t.html),e.addTerm(a);else{if("tags-table"!==r.table)return!1;a=e.termsArr[t.index],e.deleteTerm(t.index),"TR"===r.target?e.addSubTerm(r.index,a):e.addTag(a)}},this.sort=function(){e.sort(e.tagsArr),e.sort(e.termsArr),e.tagsTable.update(e.tagsArr),e.termsTable.update(e.termsArr)},this.save=function(){this.sort(),this.surveyId?e.overwriteSurvey(this.surveyId).success(function(){s.navigate("chart")}):e.saveNewSurvey().then(function(t){s.surveyId=t,r.addSurvey(e.surveyId,e.surveyData),s.navigate("chart")})},this.deleteSurveyById=function(t){confirm("Do you really want to delete this survey and all its data?")&&r.deleteSurvey(t)}})}(),function(){"use strict";angular.module("app").service("model",function(t){function e(){for(var t=0,e=a.tagsArr.length;t<e;t++){var r=a.tagsArr[t];r[2]&&(r[2]=r[2].join(","))}}function r(t){var e=[];for(var r in t)e.push([r,t[r]]);return a.sort(e)}var a=this,n="api/tags.php";this.initByExcel=function(t){try{for(var e,a=t.Sheets["Complete responses"],n=t.Sheets.Overview,s={},i=2;e=a["K"+i];){for(var o=e.w.trim().toLowerCase().split(/ and | or | - | but |\.|,|;|:|\?|!|&+/),d=0,u=o.length;d<u;d++){var l=o[d].trim();l.length&&(s[l]?s[l]++:s[l]=1)}i++}this.tagsArr=r(s),this.termsArr=[],this.sort(this.tagsArr),this.surveyData={survey_google_id:n.A2.w,question:n.C2.w}}catch(c){bootstrapAlert("Could not parse answers from Excel file")}},this.getTagsBySurveyId=function(e){return t.get(n+"?tags&surveyId="+e).success(function(t){a.tagsArr=t})},this.getTermsBySurveyId=function(e){return t.get(n+"?terms&surveyId="+e).success(function(t){a.termsArr=t})},this.saveNewSurvey=function(){return e(),t.post(n,{survey_google_id:this.surveyData.survey_google_id,question:this.surveyData.question,tagsArr:this.tagsArr,termsObj:this.termsArr}).then(function(t){return a.surveyId=t.data})},this.overwriteSurvey=function(r){return e(),this.truncateTags(r).success(function(){return t.put(n,{surveyId:r,tagsArr:a.tagsArr,termsObj:a.termsArr})})},this.addTag=function(t){this.tagsArr.unshift(t),this.tagsTable.addRow(t)},this.addTags=function(t){this.tagsArr=t.concat(this.tagsArr),this.tagsTable.addRows(t)},this.addSubTerm=function(t,e){var r=this.tagsArr[t];r[2]?(r[2].push(e[0]),r[3].push(e[1])):(r.push([e[0]]),r.push([e[1]])),this.tagsTable.addSubTerm(t,e)},this.addTerm=function(t){this.termsArr.unshift(t),this.termsTable.addRow(t)},this.addTerms=function(t){this.termsArr=t.concat(this.termsArr),this.termsTable.addRows(t)},this.deleteTag=function(t){this.tagsArr.splice(t,1),this.tagsTable.deleteRow(t)},this.deleteSubTerm=function(t,e){var r=this.tagsArr[t],a=r[2],n=a.indexOf(e),s=[e,r[3][n]];return a.splice(n,1),r[3].splice(n,1),0===a.length&&r.splice(2,2),this.tagsTable.deleteSubTerm(t,n),s},this.deleteTerm=function(t){this.termsArr.splice(t,1),this.termsTable.deleteRow(t)},this.updateTag=function(t,e,r,a,n){if("tags-table"===t)if("SPAN"===r)this.tagsArr[e][0]=a;else{var s=this.tagsArr[e][2];s[s.indexOf(n)]=a}else this.termsArr[e][0]=a},this.truncateTags=function(e){return t["delete"](n+"?surveyId="+e)},this.strToArr=function(t){var e=[];return t[2].forEach(function(r,a){e.push([r,t[3][a]])}),e},this.sort=function(t){function e(t,e){return t[1]>e[1]?-1:t[1]<e[1]?1:0}return t.sort(e)},this.splitTags=function(t,e){for(var r=this.tagsArr.concat(this.termsArr),a=0,n=r.length,s=0;a<n&&r[a][1]>=e;)!s&&a>t&&(s=r[a][1]),a++;if(this.tagsArr=r.slice(0,a),this.termsArr=r.slice(a),this.tagsTable.create(this.tagsArr),this.termsTable.create(this.termsArr),s){var i=a;do i--;while(i>=0&&r[i][1]<=s);this.tagsTable.makePinkRows(i,a),bootstrapAlert("The <b>number of filtered tags</b> is greater then <b>"+t+"</b>, because too many tags have repeat count <b>"+s+"</b> and less, so I don't know what to do with them. Those tags are marked with stripes.")}}})}(),function(){"use strict";angular.module("app").service("surveys",function(t){var e=this,r="api/surveys.php";this.loadSurveys=function(){return t.get(r).success(function(t){e.surveys=t})},this.addSurvey=function(t,e){this.surveys[t]=e},this.deleteSurvey=function(a){return t["delete"](r+"?surveyId="+a).success(function(){delete e.surveys[a]})},this.findByGoogleId=function(t){for(var e in this.surveys)if(this.surveys[e].survey_google_id===t)return e;return-1}})}(),function(){var t='<div class="modal fade"><div class=modal-dialog><div class=modal-content><div class=modal-body><button class=close data-dismiss=modal>&times;</button><br>',e="</div></div></div></div>";window.bootstrapAlert=function(r){$("#modal-placeholder").append(t+r+'<br><button class="btn btn-sm btn-primary center-block m-t-1" data-dismiss=modal> &nbsp; Ok &nbsp; </button>'+e),$(".modal").modal("show").find(".btn-primary").focus()},window.bootstrapConfirm=function(r,a,n,s){$("#modal-placeholder").append(t+r+'<br><button class="btn btn-sm btn-primary pull-xs-right m-l-2 m-y-1" data-dismiss=modal>&nbsp; '+a+' &nbsp;</button><button class="btn btn-sm btn-secondary pull-xs-right m-y-1" data-dismiss=modal>&nbsp; '+n+' &nbsp;</button><br class="clearfix"><br>'+e);var i=$(".modal");i.modal("show"),i.find(".btn-primary").on("click",function(){s(1)}).focus(),i.find(".btn-secondary").on("click",function(){s(2)})}}();