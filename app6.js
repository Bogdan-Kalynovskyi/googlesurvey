"use strict";function Chart(t){var e,n,s,r=this;this.create=function(n,a){google.charts.setOnLoadCallback(function(){function i(t){for(var e="",n=0;n<t.length;n++){var s=t[n].toString().replace(/"/g,'""');s.search(/("|,|\n)/g)>=0&&(s='"'+s+'"'),e+=n>0?","+s:s}return e+"\n"}for(var o="",d=0,l=n.length,c=new Array(l+1);d<l;d++){var u=n[d],h=u[1]/total*100,f=[u[0],h],g=[u[0],h,u[1]];c[d+1]=f,o+=i(g)}r.csvStr=o,r.csvBlob=new Blob([o],{type:"text/csv;charset=utf-8;"}),c[0]=["","Tag %"],e=google.visualization.arrayToDataTable(c),t.style.height=28*l+"px",s||(s=new google.charts.Bar(t));var p={textStyle:{fontName:"Helvetica, Arial"},titleTextStyle:{fontName:"Helvetica, Arial"}};s.draw(e,{bars:"horizontal",annotations:p,legend:p,tooltip:p,titleTextStyle:p,hAxis:p,vAxis:p}),$("#comment-chart").html(a.question)})},this.update=function(){clearTimeout(n),n=setTimeout(function(){s&&s.draw(e,{bars:"horizontal"})},100)}}function byId(t){return document.getElementById(t)}function SimpleTable(t){this.create=function(e){for(var n="",s=0,r=e.length;s<r;s++){var a=e[s];n+="<tr><td>"+a[0]+"</td><td>"+(100*a[1]/total).toFixed(2)+"%</td><td>"+a[1]+"</td></tr>"}t.innerHTML='<table class="table table-striped table-bordered table-hover"><thead class="thead-default"><tr><th>Tag</th><th>%</th><th>Answers</th></tr></thead><tbody>'+n+"</tbody></table>"}}function Table(t,e){function n(t){return(100*t/total).toFixed(2)}function s(t,s){var r,a,i,o,d,l,c="";switch(e){case TBL_tags:for(r in t){if(o=t[r],d=o[2]){s&&(d=d.split(","),o[2]=d,o[3]=o[3].split(",")),l="<ul>";for(a in d)l+="<li><span draggable=true>"+d[a]+"</span><del-syn>×</del-syn><dupl-syn>clone</dupl-syn></li>";l+="</ul>"}else l="";c+='<tr ondragover="return false"><td><input type=checkbox></td><td><span draggable=true>'+o[0]+"</span>"+l+"</td><td>"+n(o[1])+"%</td><td>"+o[1]+"</td><td class=del-line>×</td></tr>"}break;case TBL_terms:for(r in t)o=t[r],c+="<tr><td><input type=checkbox></td><td><span draggable=true>"+o[0]+"</span></td><td>"+n(o[1])+"%</td><td>"+o[1]+"</td><td class=del-line>×</td></tr>";break;case TBL_answers:for(r in t){if(o=t[r],d=o[1]){for(d=d.split(","),l="<ul>",a=0,i=d.length-1;a<i;a++){var u=s[d[a]];u?l+="<li><text>"+u[0]+"</text><del-tag>×</del-tag></li>":o[1].replace(a+",","")}l+="</ul>"}else l="";c+='<tr ondragover="return false"><td><text>'+o[0]+"</text>"+l+"</td></tr>"}break;case TBL_short:for(r in t){if(o=t[r],d=o[2]){l="<ul>";for(a in d)l+="<li>"+d[a]+"</li>";l+="</ul>"}else l="";c+="<tr><td><input type=checkbox></td><td draggable=true>"+o[0]+l+"</td><td>"+n(o[1])+"%</td><td>"+o[1]+"</td></tr>"}}return c}function r(){g=t.querySelector("thead input"),g.onchange=function(){var t,n,s=h.children,r=this.checked;if(e===TBL_terms)for(t in p)p[t]&&(s[t].children[0].children[0].checked=r);else for(t=0,n=s.length;t<n;t++)s[t].children[0].children[0].checked=r}}function a(t){for(;t&&"TR"!==t.tagName;)t=t.parentNode;return t}function i(t){for(;t&&t.getAttribute&&!t.getAttribute("ondragover");)t=t.parentNode;return t}function o(t){var e=a(t),n=Array.prototype.slice.call(h.children);return n.indexOf(e)}function d(t){var e=t.parentNode,n=Array.prototype.slice.call(e.children);return n.indexOf(t)}function l(){var n,s,r=t.children[0];h.addEventListener("dragstart",function(t){window.getSelection?window.getSelection().removeAllRanges():document.selection&&document.selection.empty();var n=t.target;if(!(n instanceof HTMLElement&&n.draggable))return!1;var s=a(n),r=n.parentNode,i="LI"===r.tagName;dragData={index:o(s),startRow:s,synPos:i?d(r):0,isSynonym:i,tblType:e},e!==TBL_short&&(g.checked=!1),f.find("input:checked").css("outline","5px solid rgba(0, 0, 255, 0.2)")}),r.addEventListener("dragenter",function(t){var a=t.target;s&&s.contains(a)||(s&&(n.style.background="",n.style.outline="",s=void 0),dragData.startRow.contains(a)||(a=e===TBL_terms?r:i(a),a!==document&&(s=a,n="THEAD"===a.tagName?a.parentNode:a,n.style.background="rgba(0, 0, 255, 0.1)",n.style.outline="2px solid blue"))),t.stopPropagation()}),document.addEventListener("dragenter",function(){s&&(n.style.background="",n.style.outline="",s=void 0)}),r.addEventListener("drop",function(t){var r=i(t.target),a=(e===TBL_tags||e===TBL_answers)&&"TR"===r.tagName,d={index:a&&o(r),isRow:a,tblType:e};s&&(n.style.background="",n.style.outline=""),ctrl.dragTag(dragData,d)})}function c(){h.addEventListener("click",function(t){var n=t.target,s=n.tagName,r=n.parentNode;if("SPAN"===s){var a=n.innerHTML;n.style.padding="0",n.innerHTML='<input value="'+a+'">';var i=n.children[0];i.focus(),i.onblur=function(){var t,s=i.value;s&&a!==i.value&&("LI"===r.tagName&&(t=d(r)),ctrl.updateTag(e===TBL_tags||e===TBL_short,o(n),t,s)),n.style.padding="",n.innerHTML=s},i.onkeyup=function(t){13!=t.keyCode&&27!=t.keyCode||this.blur()}}else"DEL-SYN"===s?ctrl.deleteSyn(o(n),d(r)):"DUPL-SYN"===s?ctrl.cloneSyn(o(n),d(r)):"DEL-TAG"===s?ctrl.deleteAnswer(o(n),d(r)):"del-line"===n.className&&ctrl.deleteRow(o(n),e===TBL_tags)})}function u(t){void 0!==t&&setTimeout(function(){var e,n=trash[t],s=n[1];e=s===!0?"tag":s===!1?"term":"subterm",$undo.prepend("<div><undo trash-id="+t+">undo</undo> <i>"+e+"</i>&nbsp; "+n[0][0]+"<del-undo>×</del-undo></div>")},0)}var h,f,g,p,v;this.draw=function(n,a){if(e===TBL_terms&&(p=Array(n.length).fill(!0)),h)return void this.update(n,a);var i=["Tags and synonyms","Unused terms","Answers","Tags"],o=["Tag","Term","","Tag"],d=[5,5,3,4],u='<table class="table table-striped table-bordered table-hover"'+(e===TBL_terms?' ondragover="return false"':"")+'><thead class="thead-default"'+(e===TBL_tags?' ondragover="return false"':"")+"><tr><th colspan="+d[e]+"><b>"+i[e]+"</b></th>";e!==TBL_answers&&(u+="</tr><tr><th><input type=checkbox></th><th>"+o[e]+"</th><th colspan="+(d[e]-2)+">Repeats</th>"),u+="</tr></thead><tbody>"+s(n,a)+"</tbody></table>",t.innerHTML=u,h=t.children[0].children[1],setTimeout(function(){f=$(h),ctrl=ctrl||angular.element(document.getElementById("logged-in")).scope().ctrl,e!==TBL_answers&&r(),l(),c()},0)},this.selectedIndexes=function(){var t,n,s=[],r=h.children;if(e===TBL_terms)for(t in p)p[t]&&r[t].children[0].children[0].checked&&s.push(t);else for(t=0,n=r.length;t<n;t++)r[t].children[0].children[0].checked&&s.push(t);return s},this.filter=function(t,e){var n,s,r=h.children;if(e.length){for(var a in t)s=t[a][0].indexOf(e)!==-1,n=r[a],s!=p[a]&&(n.style.display=s?"":"none"),p[a]=s,v||(n.children[0].children[0].checked=!1);g.checked=!1,v=!0}else{for(a in t)p[a]||(r[a].style.display="");p=Array(t.length).fill(!0),v=!1}},this.updatePerc=function(t){var s,r,a=h.children;if(e===TBL_terms)for(s in p)p[s]&&(a[s].children[2].innerHTML=n(t[s][1])+"%");else for(s=0,r=a.length;s<r;s++)a[s].children[2].innerHTML=n(t[s][1])+"%"},this.updateCount=function(t,e){h.children[t].children[3].innerHTML=e},this.clear=function(){h&&(h.innerHTML="")},this.update=function(t,n){h.innerHTML="",e===TBL_terms&&(p=[]),this.addRows(t,n)},this.addRow=function(t){f.prepend(s([t])),e===TBL_terms&&p.unshift(!0)},this.addRows=function(t,n){f.prepend(s(t,n)),e===TBL_terms&&(p=Array(t.length).fill(!0).concat(p))},this.addSyn=function(t,s,r,a){var i,o=h.children[t],d=o.children[e===TBL_tags?1:0],l=d.children[1];i=e===TBL_tags?"<li><span draggable=true>"+s+"</span><del-syn>×</del-syn><dupl-syn>clone</dupl-syn></li>":"<li><text>"+s+"</text><del-tag>×</del-tag></li>",l?a?$(l.children[a]).after(i):$(l).prepend(i):$(d).append("<ul>"+i+"</ul>"),e!==TBL_answers&&(o.children[2].innerHTML=n(r)+"%",o.children[3].innerHTML=r)},this.addSyns=function(t,n){var s=h.children[t].children[e===TBL_tags?1:0],r=$(s.children[1]),a="";for(var i in n)a+=e===TBL_tags?"<li><span draggable=true>"+n[i]+"</span><del-syn>×</del-syn><dupl-syn>clone</dupl-syn></li>":"<li><text>"+n[i]+"</text><del-tag>×</del-tag></li>";r.prepend(a)},this.deleteSyn=function(t,s,r,a){var i=h.children[t],o=i.children[e===TBL_tags?1:0],d=o.children[1];d.removeChild(d.children[s]),e!==TBL_answers&&(i.children[2].innerHTML=n(r)+"%",i.children[3].innerHTML=r,u(a))},this.deleteRow=function(t,n){h.removeChild(h.children[t]),e===TBL_terms&&p.splice(t,1),u(n)}}function alreadyLoggedIn(){var t=byId("logged-in"),e=byId("logged-out");angular.bootstrap(t,["app"]),e&&(e.style.display="none",t.style.display="block")}var app=angular.module("app",[]).config(["$httpProvider",function(t){function e(t){!document.hidden&&n&&(bootstrapAlert(t),n=!1,setTimeout(function(){n=!0},2e4))}var n=!0,s=navigator.userAgent,r=s.indexOf("MSIE ");r!==-1?r=parseInt(s.split("MSIE ")[1]):s.match(/trident.*rv\:11\./)&&(r=11),r!==-1&&(document.documentElement.className="ie"+r,r<10&&bootstrapAlert("You are using Internet Explorer "+r+". Sorry, but we are only supporting Internet Explorer 10 and above. Chrome, Firefox and Safari are also supported.")),window.onbeforeunload=function(){n=!1},t.defaults.headers.common.Authorization=xsrfToken,t.interceptors.push(["$q","$injector",function(t,s){function r(r,i){if(a<16){a++;var o=s.get("$timeout");return o(function(){var t=s.get("$http");return t(r)},600*a)}if(n){e(i===-1?"Oops, it seems you have lost internet connection":"We are restarting server. Could you please try in a minute?"),a=0;var d=t.defer();return d.reject(),d.promise}}var a=0;return{response:function(e){return e||t.when(e)},responseError:function(e){switch(e.status){case 400:case 401:bootstrapAlert(e.data),401===e.status&&$(".modal button").click(function(){location.reload()});break;case-1:if(e.status===-1&&e.config.timeout)break;return r(e.config,e.status)}return t.reject(e)}}}])}]);app.directive("customOnChange",function(){return{restrict:"A",link:function(t,e,n){var s=t.$eval(n.customOnChange);e.bind("change",s)}}});var trash,TBL_tags=0,TBL_terms=1,TBL_answers=2,TBL_short=3;google.charts.load("44",{packages:["bar"]}),app.controller("dashboard",["model","surveys","$rootScope","$q",function(t,e,n,s){function r(t){for(b=t,byId("btn-"+m[t-1]).classList.remove("disabled"),byId("btn-"+m[t]).classList.remove("disabled"),t++;t<m.length;t++)byId("btn-"+m[t]).classList.add("disabled")}function a(t){h=!1,p.filterTerm="",trash=[],byId("tags-question").innerHTML=t,$undo[0].innerHTML="",r(2),p.navigate(1)}function i(t){t&&(g=!0,u=!0,p.splitMax(),a(t))}function o(){t.recalcPerc(),l()}function d(e,n){var s;switch(e.tblType){case TBL_tags:if(n.tblType===TBL_tags){if(e.index===n.index)return;if(n.isRow)e.isSynonym?(s=t.deleteSyn(e.index,e.synPos),t.addSyn(n.index,s[0],s[1])):(t.addSyns(e.index,n.index),t.deleteTag(e.index));else{if(!e.isSynonym)return;s=t.deleteSyn(e.index,e.synPos),t.addTag(s)}}else e.isSynonym?s=t.deleteSyn(e.index,e.synPos):(s=t.tags[e.index],s[2]&&t.addTerms(s),t.deleteTag(e.index)),t.addTerm(s);l();break;case TBL_terms:if(n.tblType!==TBL_tags)return;s=t.terms[e.index],t.deleteTerm(e.index),n.isRow?t.addSyn(n.index,s[0],s[1]):t.addTag(s),l();break;case TBL_short:if(n.tblType!==TBL_answers)return;p.addAnswer(n.index,e.index)}}function l(){clearTimeout(T),T=setTimeout(function(){p.sId&&!v?(p.surveys[p.sId].total=total,t.overwriteSurvey(p.sId)):(v=!1,t.saveNewSurvey().then(function(n){p.sId=n,e.add(t.surveyId,t.surveyData)}))},600),u=!1,f=!1}var c,u,h,f,g,p=this,v=!1,y=new Chart(byId("tags-chart")),m=["surveys","tags","answers","chart"],b=0;this.maxTags=10,e.load().success(function(){$("#loading").remove(),p.navigate(0),p.surveys=e.surveys}),window.addEventListener("resize",function(){3===c&&y.update()}),this.navigate=function(n){if(n>b)return void(0===b?bootstrapAlert("Nothing to display, please load survey first"):bootstrapAlert('Please open "Answers" tab first, to see if everything is correct'));if(void 0!==c&&(byId("btn-"+m[c]).classList.remove("active"),byId(m[c]).style.display="none"),byId("btn-"+m[n]).classList.add("active"),byId(m[n]).style.display="block",c=n,2===n&&(h?t.updateShort():g?(t.prepareAnswers(),t.saveAnswers(this.sId),r(3),h=!0):t.getAnswers(this.sId).success(function(){r(3),h=!0})),!f&&3===n){y.create(t.tags,e.surveys[this.sId]);var s=new SimpleTable(byId("chart-table"));s.create(t.tags),f=!0}},this.loadSurvey=function(n){g=!1,this.sId=n,a(e.surveys[this.sId].question),total=+e.surveys[n].total,t.clearTables(),t.getTags(n).success(function(){p.maxTags=t.tags.length,p.minCount=t.tags[p.maxTags-1][1]}),t.getTerms(n)},this.splitMax=function(){this.maxTags||(this.maxTags=1),this.minCount=t.splitMax(this.maxTags,u),l()},this.splitMin=function(){this.maxTags=t.splitMin(this.minCount),l()},this.cloneSurvey=function(n){this.loadSurvey(n),t.surveyData=e.surveys[n],v=!0},this.uploadFile=function(n){var s=n.target.files[0];if(s&&!s.$error){var r=new FileReader;r.onload=function(n){var s=XLS.read(n.target.result,{type:"binary"}),r=s.Sheets.Overview,a=e.findByGoogleId(r.A2.w),o="Survey with this id has already been uploaded. Do you want to overwrite existing one or add as a new survey?";a!==-1?bootstrapConfirm(o,"Add as new","Overwrite",function(e){2===e?p.sId=a:p.sId=void 0,i(t.initByExcel(s))}):(p.sId=void 0,i(t.initByExcel(s)))},r.readAsBinaryString(s)}},this.addTags=function(){var e=[];this.bulkAdd.toLowerCase().split(",").forEach(function(t){var n=t.trim();n.length&&e.push([n,0])}),this.bulkAdd="",t.addTags(e),l()},this.updateTag=function(){t.updateTag.apply(t,arguments),l()},this.deleteRow=function(e,n){if(n){total-=t.tags[e][1];var s=trash.push([t.tags[e],n])-1;t.deleteTag(e,s)}else total-=t.terms[e][1],s=trash.push([t.terms[e],n])-1,t.deleteTerm(e,s);o()},this.deleteSyn=function(e,n){var s=t.deleteSyn(e,n,trash.length);total-=+s[1],trash.push([s,e]),o()},this.cloneSyn=function(e,n){total+=t.cloneSyn(e,n),o()},this.addAnswer=function(e,n){t.addAnswer(e,n),t.patchAnswer(this.sId,e),f=!1},this.deleteAnswer=function(e,n){t.deleteAnswer(e,n),t.patchAnswer(this.sId,e),f=!1},this.undoRow=function(e){var n=trash[e],s=n[0],r=n[1];r===!0?t.addTag(s):r===!1?t.addTerm(s):t.addSyn(Math.min(r,t.tags.length-1),s[0],s[1]),total+=+s[1],o()},this.dragTag=function(e,n){var s=t.getSelected(e.tblType),r=s.length;if(r)for(var a={tblType:e.tblType,isSynonym:!1};r--;)a.index=s[r],d(a,n);else d(e,n)},this.sort=function(){t.sort(t.terms,!0,!0)},this.filterTerms=function(){t.filterTerms(this.filterTerm)};var T;this.downloadCsv=function(){var t="tags_"+e.surveys[this.sId].survey_google_id+".csv";if(navigator.msSaveBlob)navigator.msSaveBlob(y.csvBlob,t);else{var n=document.createElement("a");if(void 0!==n.download){var s=URL.createObjectURL(y.csvBlob);n.setAttribute("href",s),n.setAttribute("download",t),n.style.visibility="hidden",document.body.appendChild(n),n.click(),setTimeout(function(){document.body.removeChild(n)},1e4)}else{var r=window.open("","","");r.document.write('<meta name=content-type content=text/csv><meta name=content-disposition content="attachment;  filename='+t+'">  '),r.document.write(y.csvStr)}}},this.deleteSurveyById=function(t){confirm("Do you really want to delete this survey and all its data?")&&(e["delete"](t),t===this.sId&&($("tr[ondragover]").remove(),$("#tags-chart").html("")))},this.logOut=function(){s.all([t.logOut(),gapi.auth2.getAuthInstance().signOut()]).then(function(){location.reload()})}}]);var total;app.service("model",["$http",function(t){function e(){var t=s.tags,e=new Array(s.tags.length);for(var n in t){var r=t[n];e[n]=r.slice(0,2),r[2]&&(e[n].push(r[2].join(",")),e[n].push(r[3].join(",")))}return e}function n(){var t=s.terms;for(var e in t)if(t[e][2]){var n=t[e],r=n[2],a=n[3];for(var i in r)s.terms.push([r[i],a[i]]);n.splice(2,2)}}var s=this,r=new Table(byId("tags-table"),TBL_tags),a=new Table(byId("terms-table"),TBL_terms),i=new Table(byId("answers-table"),TBL_answers),o=new Table(byId("short-table"),TBL_short);this.initByExcel=function(t){for(var e,n=t.Sheets["Complete responses"],s=t.Sheets.Overview,r={},a=2,i=/ and | or | - | but | nor |\/|\.|,|;|:|\?|!|&+/,o=/ very | so much | much | many | a | an | the | such | hi | so | lot of | lots of /g,d=/  /g;e=n["K"+a];){var l=e.w.toLowerCase();l=l.split(i);for(var c in l){var u=(" "+l[c]).replace(o," ").replace(d," ").trim();u.length&&(r[u]?r[u]++:r[u]=1)}a++}var h=s.C2.w,f=+s.E2.w;this.surveyData={survey_google_id:s.A2.w,question:h,total:f},this.tags=[],this.answers=[];for(a in r)this.tags.push([a,r[a]]),this.answers.push(a);return this.answers.sort(),this.terms=[],total=f,h},this.getTags=function(e){return t.get("api/tags.php?surveyId="+e).success(function(t){s.tags=t,r.draw(t,!0)})},this.getTerms=function(e){return t.get("api/terms.php?surveyId="+e).success(function(t){s.terms=t,a.draw(t)})},this.getAnswers=function(e){return t.get("api/answers.php?surveyId="+e).success(function(t){s.answers=t,i.draw(t,s.tags),o.draw(s.tags)})},this.saveNewSurvey=function(){return t.post("api/surveys.php",{survey_google_id:this.surveyData.survey_google_id,question:this.surveyData.question,tags:e(this.tags),terms:this.terms,total:total}).then(function(t){return s.surveyId=t.data})},this.overwriteSurvey=function(n){return t.put("api/surveys.php",{surveyId:n,tags:e(s.tags),terms:this.terms,total:total})},this.saveAnswers=function(e){return t.post("api/answers.php",{surveyId:e,answers:this.answers})},this.patchAnswer=function(e,n){return t.patch("api/answers.php",{surveyId:e,answer:this.answers[n][0],tags:this.answers[n][1]})},this.addTag=function(t){this.tags.unshift(t),r.addRow(t)},this.addTags=function(t){this.tags=t.concat(this.tags),r.addRows(t)},this.addSyn=function(t,e,n){var s=this.tags[t];s[2]?(s[2].unshift(e),s[3].unshift(n)):(s.push([e]),s.push([n])),s[1]+=+n,r.addSyn(t,e,s[1])},this.addSyns=function(t,e){var n=this.tags[t],s=this.tags[e],a=n[2];this.addSyn(e,n[0],n[1]),a&&(s[2]=a.concat(s[2]),s[3]=n[3].concat(s[3]),r.addSyns(e,a))},this.addTerm=function(t){this.terms.unshift(t),a.addRow(t)},this.addTerms=function(t){var e=[],n=0,s=t[2],r=t[3];for(var i in s)n+=+r[i],e.push([s[i],r[i]]);t[1]-=n,this.terms=e.concat(this.terms),a.addRows(e)},this.deleteTag=function(t,e){r.deleteRow(t,e),this.tags.splice(t,1)},this.deleteSyn=function(t,e,n){var s=this.tags[t],a=s[2],i=s[3],o=[a[e],i[e]];return a.splice(e,1),s[1]-=+i[e],i.splice(e,1),r.deleteSyn(t,e,s[1],n),o},this.cloneSyn=function(t,e){var n=this.tags[t],s=n[2],a=n[3],i=s[e],o=+a[e];return s.splice(e,0,i),a.splice(e,0,o),n[1]+=o,r.addSyn(t,i,n[1],e),o},this.deleteTerm=function(t,e){a.deleteRow(t,e),this.terms.splice(t,1)},this.updateTag=function(t,e,n,s){t?n?this.tags[e][2][n]=s:this.tags[e][0]=s:this.terms[e][0]=s},this.addAnswer=function(t,e){this.answers[t][1]+=e+",";var n=this.tags[e];i.addSyn(t,n[0]),total++,o.updateCount(e,++n[1]),o.updatePerc(this.tags)},this.deleteAnswer=function(t,e){var n=this.answers[t][1].split(","),s=n.splice(e,1);this.answers[t][1]=n.join(","),i.deleteSyn(t,e),total--,o.updateCount(s,--this.tags[s][1]),o.updatePerc(this.tags)},this.prepareAnswers=function(){total=0;for(var t in this.tags)this.tags[t][1]=0;for(var e in this.answers){var n=this.answers[e],s="";for(t in this.tags){var r=this.tags[t];if(n.indexOf(r[0])===-1){var a=r[2];if(a)for(var d in a)if(n.indexOf(a[d])!==-1){s+=t+",",r[1]++,total++;break}}else s+=t+",",r[1]++,total++}this.answers[e]=[n,s]}i.draw(this.answers,this.tags),o.draw(this.tags)};var d=1;this.sort=function(t,e,n){function s(t,e){return t[0]>e[0]?d:t[0]<e[0]?-d:0}function r(t,e){return t[1]>e[1]?-1:t[1]<e[1]?1:0}return t.sort(e?s:r),n&&(d*=-1,a.draw(this.terms),document.querySelector(".pull-xs-right").innerHTML="Sort terms "+(1===d?"▼":"▲")),t},this.clearTables=function(){for(var t in l)l[t].clear()},this.recalcPerc=function(){r.updatePerc(this.tags),a.updatePerc(this.terms)},this.updateShort=function(){o.draw(this.tags)};var l=[r,a,i,o];this.getSelected=function(t){return l[t].selectedIndexes()},this.splitMax=function(t,e){var s=this.tags.concat(this.terms);return t=Math.min(t,s.length),this.sort(s),this.tags=s.slice(0,t),this.terms=s.slice(t),e||n(),this.sort(this.tags,!0),this.sort(this.terms,!0),r.draw(this.tags,e),a.draw(this.terms),this.tags[t-1][1]},this.splitMin=function(t){var e=this.tags.concat(this.terms),s=0,i=e.length;for(this.sort(e);s<i&&e[s][1]>=t;)s++;return this.tags=e.slice(0,s),this.terms=e.slice(s),n(),this.sort(this.tags,!0),this.sort(this.terms,!0),r.draw(this.tags),a.draw(this.terms),s},this.filterTerms=function(t){a.filter(this.terms,t)},this.logOut=function(){return t.post("api/login.php",{logout:xsrfToken})}}]),app.service("surveys",["$http",function(t){var e=this,n="api/surveys.php";this.load=function(){return t.get(n).success(function(t){e.surveys=t})},this.add=function(t,e){this.surveys[t]=e},this["delete"]=function(s){return t["delete"](n+"?surveyId="+s).success(function(){delete e.surveys[s]})},this.findByGoogleId=function(t){for(var e in this.surveys)if(this.surveys[e].survey_google_id===t)return e;return-1}}]);var $undo=$("#undo"),ctrl,dragData;$undo[0].onclick=function(t){var e=t.target,n=e.tagName;"UNDO"===n?(ctrl.undoRow(e.getAttribute("trash-id")),$undo[0].removeChild(e.parentNode)):"DEL-UNDO"===n&&$undo[0].removeChild(e.parentNode)},function(){function t(t){t.show().addClass("in"),t.add(".modal button").on("click",function(){t.removeClass("in"),setTimeout(function(){t.remove()},300)}),t.find(".modal-dialog").on("click",function(t){return t.stopPropagation(),!1})}var e='<div class="modal fade"><div class=modal-dialog><div class=modal-content><div class=modal-body><button class=close>&times;</button><br>',n="</div></div></div></div>";window.bootstrapAlert=function(s){$("#modal-placeholder").append(e+s+'<br><button class="btn btn-sm btn-primary m-t-1 p-x-3" style="margin: 0 auto;display: block;">Ok</button>'+n);var r=$(".modal");t(r),r.find(".btn-primary").focus()},window.bootstrapConfirm=function(s,r,a,i){$("#modal-placeholder").append(e+s+'<br><button class="btn btn-sm btn-primary pull-xs-right m-l-3 m-y-1 p-x-2" style="margin-right: 137px!important;">'+r+'</button><button class="btn btn-sm btn-secondary pull-xs-right m-y-1 p-x-2">'+a+'</button><br class="clearfix"><br><br>'+n);var o=$(".modal");t(o),o.find(".btn-primary").on("click",function(){i(1)}).focus(),o.find(".btn-secondary").on("click",function(){i(2)})}}(),window.xsrfToken&&alreadyLoggedIn(),window.onPlatformLoad&&onPlatformLoad();